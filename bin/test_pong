#!/bin/bash

source bin/stack_functions

preamble_setup

faucet_log=inst/forch-faucet-1/faucet.log
forch_log=inst/forch-faucet-1/forch.log

#################################################################################

function simple_ping {
    sleep 20
    echo
    echo
    echo ping $label `date`
    label=$1
    ping=`docker exec forch-faux-1 ping -q -c 10 192.168.1.0 | fgrep packets`
    echo Base ping results $ping
    ping=${ping#*transmitted,}
    ping=${ping%received,*}
    echo ping $label $((ping >= 7)) | tee -a $TEST_RESULTS
}

rm -f $faucet_log inst/forch-faucet-1/ofchannel.log
tail -F $faucet_log &

for iter in {01..20}; do
    echo Starting iteration $iter

    sudo ip link set t1sw1-eth28 down
    simple_ping sw1down$iter

    sudo ip link set t1sw1-eth28 up
    simple_ping sw1isup$iter

    sudo ip link set t1sw2-eth28 down
    simple_ping sw2down$iter

    sudo ip link set t1sw2-eth28 up
    simple_ping sw2isup$iter
done

fgrep "Cold start" inst/forch-faucet-1/faucet.log | sort -n

echo Done with test_pong. | tee -a $TEST_RESULTS
